<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Word Jumper: English Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            touch-action: none;
            font-family: 'Press Start 2P', cursive;
        }

        canvas {
            display: block;
            margin: 0 auto;
            background: linear-gradient(#1a2a6c, #b21f1f, #fdbb2d);
        }

        #ui-layer {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #fff;
            text-shadow: 2px 2px #000;
            pointer-events: none;
            width: calc(100% - 20px);
            z-index: 10;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border: 4px solid #000;
            border-radius: 10px;
            text-align: center;
            z-index: 100;
            width: 90%;
            max-width: 550px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 8px 8px 0px rgba(0,0,0,0.2);
        }

        .btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 10px;
            cursor: pointer;
            margin: 5px;
            border-bottom: 4px solid #b33939;
            font-family: 'Press Start 2P', cursive;
            transition: all 0.1s;
        }

        .btn:hover { background: #ff6b81; transform: translateY(-1px); }
        .btn:active { transform: translateY(2px); border-bottom-width: 2px; }

        .category-btn {
            background: #2ed573;
            border-bottom-color: #26af5a;
            width: 100%;
            margin-bottom: 8px;
            font-size: 11px;
        }

        #controls {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            pointer-events: none;
        }

        .touch-btn {
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.25);
            border: 3px solid white;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            pointer-events: auto;
            user-select: none;
            backdrop-filter: blur(4px);
        }

        .touch-btn:active { background: rgba(255, 255, 255, 0.5); }

        .hidden { display: none !important; }
        .heart { color: #ff4757; font-size: 20px; margin-left: 5px; }

        textarea {
            width: 100%;
            height: 120px;
            border: 2px solid #000;
            margin-top: 10px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            background: #f8f9fa;
        }

        .branding {
            font-size: 8px;
            color: #666;
            margin-top: 15px;
            line-height: 1.6;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="flex justify-between items-start">
            <div>
                <div class="text-sm">TARGET: <span id="word-to-spell" class="text-yellow-400">---</span></div>
                <div class="mt-1 text-[10px]">PROGRESS: <span id="current-spelling" class="text-green-400"></span></div>
            </div>
            <div id="lives-display" class="flex"></div>
        </div>
    </div>

    <!-- Category Menu -->
    <div id="category-modal" class="modal">
        <h1 class="text-lg mb-4 text-blue-600">CHOOSE TOPIC</h1>
        <div id="category-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
        <hr class="my-4">
        <button class="btn bg-gray-500 border-gray-700 w-full" onclick="showImport()">MANAGE WORDS</button>
        <div class="branding">
            Made with ❤️ for learners.<br>elessons14@gmail.com
        </div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="modal hidden">
        <h1 class="text-lg mb-2">WORD MANAGER</h1>
        <p class="text-[10px] text-gray-500 mb-2">Paste words (comma separated)</p>
        
        <div class="flex flex-col gap-2 mb-2">
            <select id="import-cat-select" class="border-2 border-black p-2 text-xs font-sans" onchange="loadWordsToTextarea()"></select>
        </div>

        <textarea id="import-text" placeholder="e.g. BREAD, MILK, JUICE, APPLE"></textarea>
        
        <div class="flex justify-center flex-wrap">
            <button class="btn" onclick="saveImport()">SAVE CHANGES</button>
            <button class="btn bg-gray-400 border-gray-600" onclick="closeImport()">BACK</button>
        </div>
    </div>

    <div id="start-modal" class="modal hidden">
        <h1 class="text-xl mb-4 text-blue-600" id="current-cat-title">READY?</h1>
        <p class="mb-4 text-xs text-gray-600">The letters are scattered! Find them in order:<br><span id="modal-target-word" class="text-lg text-orange-500">WORD</span></p>
        <button class="btn" onclick="startGame()">START SEARCHING!</button>
    </div>

    <div id="game-over-modal" class="modal hidden">
        <h1 class="text-2xl mb-4 text-red-600">GAME OVER</h1>
        <p id="final-score-text" class="mb-4 text-xs">Try again to master the word!</p>
        <button class="btn" onclick="location.reload()">RETRY</button>
    </div>

    <div id="win-modal" class="modal hidden">
        <h1 class="text-xl mb-4 text-green-600">BRILLIANT!</h1>
        <p id="win-message" class="mb-4 text-sm"></p>
        <button class="btn" onclick="nextWord()">NEXT WORD</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="controls">
        <div class="flex gap-4">
            <div class="touch-btn" id="leftBtn">←</div>
            <div class="touch-btn" id="rightBtn">→</div>
        </div>
        <div class="touch-btn" id="jumpBtn">↑</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let categories = {
            "Shopping": ["APPLE", "BREAD", "MILK", "SHIRT", "PRICE", "STORE", "GROCERY", "WALLET", "MARKET", "CHEESE", "BANANA", "CASHIER", "DISCOUNT", "RECEIPT", "BASKET"],
            "Cooking": ["KITCHEN", "OVEN", "KNIFE", "PLATE", "SPOON", "BOIL", "RECIPE", "FLAVOR", "SPICES", "FRYING", "BAKING", "CHOPPING", "DINNER", "STOVE", "FRIDGE"],
            "Body Parts": ["HEAD", "HAND", "FOOT", "ELBOW", "MOUTH", "EYES", "SHOULDER", "STOMACH", "FINGER", "TONGUE", "THROAT", "KNEE", "ANKLE", "WRIST", "HEART"],
            "Days & Time": ["MONDAY", "FRIDAY", "SUNDAY", "WEEKEND", "TODAY", "MORNING", "AFTERNOON", "EVENING", "JANUARY", "AUGUST", "MINUTE", "SECOND", "QUARTER", "CALENDAR", "FUTURE"],
            "Weather": ["SUNNY", "CLOUDY", "RAINY", "STORM", "WINDY", "SNOWY", "FREEZING", "THUNDER", "LIGHTNING", "BREEZE", "UMBRELLA", "WEATHER", "AUTUMN", "SUMMER", "WINTER"],
            "Travel": ["AIRPLANE", "TICKET", "PASSPORT", "JOURNEY", "STATION", "AIRPORT", "BAGGAGE", "HOTEL", "TOURIST", "MAP", "CAMERA", "ISLAND", "MOUNTAIN", "SEASIDE", "FLIGHT"],
            "House": ["WINDOW", "DOOR", "GARDEN", "BEDROOM", "SHOWER", "MIRROR", "CARPET", "PILLOW", "BLANKET", "GARAGE", "STAIRS", "CHIMNEY", "CURTAIN", "TOILET", "LIVING"],
            "Animals": ["TIGER", "GIRAFFE", "MONKEY", "RABBIT", "CHICKEN", "DOLPHIN", "ELEPHANT", "PENGUIN", "LION", "TURTLE", "ZEBRA", "SQUIRREL", "HAMSTER", "PARROT", "KANGAROO"]
        };

        const config = {
            gravity: 0.6,
            jumpStrength: -15,
            speed: 7,
            groundHeight: 80,
            maxLives: 3,
            layerHeight: 110, // Distance between vertical layers
        };

        let activeCategoryName = "";
        let activeCategory = [];
        let currentWordIndex = 0;
        let targetWord = '';
        let collectedLetters = '';
        let lives = config.maxLives;
        let gameRunning = false;
        
        const player = {
            x: 50, y: 0, width: 34, height: 46,
            velX: 0, velY: 0, grounded: false,
            color: '#FF5733'
        };

        let platforms = [];
        let letters = [];
        let particles = [];
        let clouds = [];
        const keys = {};

        // --- WORD MANAGEMENT ---

        function initCategories() {
            const list = document.getElementById('category-list');
            const select = document.getElementById('import-cat-select');
            list.innerHTML = '';
            select.innerHTML = '';
            
            Object.keys(categories).forEach(cat => {
                const b = document.createElement('button');
                b.className = 'btn category-btn';
                b.innerText = cat;
                b.onclick = () => selectCategory(cat);
                list.appendChild(b);

                const opt = document.createElement('option');
                opt.value = cat;
                opt.innerText = cat;
                select.appendChild(opt);
            });
        }

        function loadWordsToTextarea() {
            const cat = document.getElementById('import-cat-select').value;
            document.getElementById('import-text').value = categories[cat].join(', ');
        }

        function showImport() {
            document.getElementById('category-modal').classList.add('hidden');
            document.getElementById('import-modal').classList.remove('hidden');
            loadWordsToTextarea();
        }

        function closeImport() {
            document.getElementById('import-modal').classList.add('hidden');
            document.getElementById('category-modal').classList.remove('hidden');
        }

        function saveImport() {
            const cat = document.getElementById('import-cat-select').value;
            const text = document.getElementById('import-text').value;
            if (text.trim()) {
                const newWords = text.split(/[,\n]/).map(w => w.trim().toUpperCase()).filter(w => w.length > 0);
                if (newWords.length > 0) {
                    categories[cat] = newWords;
                    alert(`Updated ${cat}!`);
                    closeImport();
                }
            }
        }

        function selectCategory(catName) {
            activeCategoryName = catName;
            activeCategory = [...categories[catName]].sort(() => Math.random() - 0.5);
            currentWordIndex = 0;
            document.getElementById('category-modal').classList.add('hidden');
            document.getElementById('current-cat-title').innerText = catName.toUpperCase();
            prepareWord();
        }

        function prepareWord() {
            targetWord = activeCategory[currentWordIndex];
            collectedLetters = '';
            document.getElementById('word-to-spell').innerText = targetWord;
            document.getElementById('current-spelling').innerText = '';
            document.getElementById('modal-target-word').innerText = targetWord;
            document.getElementById('start-modal').classList.remove('hidden');
            setupLevel();
        }

        // --- GAME ENGINE ---

        function setupLevel() {
            const groundY = canvas.height - config.groundHeight;
            player.x = canvas.width / 2 - player.width / 2;
            player.y = groundY - player.height;
            player.velX = 0; player.velY = 0;

            platforms = [{ x: 0, y: groundY, w: canvas.width, h: config.groundHeight }];
            letters = [];
            
            // Generate a full screen of random platforms
            const numLayers = Math.floor(groundY / config.layerHeight);
            let platformPool = [];

            for (let i = 1; i <= numLayers; i++) {
                const y = groundY - (i * config.layerHeight);
                // Each layer has 2-3 platforms
                const count = 2 + Math.floor(Math.random() * 2);
                for (let j = 0; j < count; j++) {
                    const w = 110 + Math.random() * 70;
                    const x = Math.random() * (canvas.width - w);
                    
                    // Collision Buffer: Check if this platform is too close to others in the same layer
                    let overlap = platformPool.some(p => p.y === y && Math.abs(p.x - x) < 150);
                    if (!overlap) {
                        const plat = { x, y, w, h: 22 };
                        platformPool.push(plat);
                        platforms.push(plat);
                    }
                }
            }

            // Shuffle the word characters
            const chars = targetWord.split('');
            const availablePlatforms = [...platformPool].sort(() => Math.random() - 0.5);

            chars.forEach((char, i) => {
                // If we ran out of platforms (unlikely), pick ground
                const plat = availablePlatforms[i] || platforms[0];
                
                letters.push({
                    char: char,
                    x: plat.x + (plat.w / 2) - 21,
                    y: plat.y - 55,
                    width: 42, height: 42,
                    collected: false,
                    floating: Math.random() * Math.PI * 2
                });
            });

            clouds = [];
            for(let i=0; i<7; i++) {
                clouds.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height*0.7, s: 0.4 + Math.random(), v: 0.2 + Math.random() * 0.3 });
            }
        }

        function startGame() {
            document.getElementById('start-modal').classList.add('hidden');
            gameRunning = true;
            updateLivesUI();
            requestAnimationFrame(gameLoop);
        }

        function updateLivesUI() {
            const display = document.getElementById('lives-display');
            display.innerHTML = '';
            for(let i=0; i<lives; i++) display.innerHTML += '<span class="heart">❤</span>';
        }

        function loseLife() {
            lives--;
            updateLivesUI();
            spawnParticles(player.x + player.width/2, player.y + player.height/2, '#ff0000');
            
            if (lives <= 0) {
                gameRunning = false;
                document.getElementById('game-over-modal').classList.remove('hidden');
            } else {
                // Flash effect or small reset
                player.velY = -5;
                player.grounded = false;
            }
        }

        function nextWord() {
            document.getElementById('win-modal').classList.add('hidden');
            currentWordIndex++;
            if (currentWordIndex >= activeCategory.length) {
                currentWordIndex = 0;
                document.getElementById('category-modal').classList.remove('hidden');
            } else {
                prepareWord();
            }
        }

        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);
        
        const setupTouch = (id, key) => {
            const el = document.getElementById(id);
            el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
            el.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
        };
        setupTouch('leftBtn', 'ArrowLeft');
        setupTouch('rightBtn', 'ArrowRight');
        setupTouch('jumpBtn', 'Space');

        function gameLoop() {
            if (!gameRunning) return;

            // Player movement
            if (keys['ArrowLeft']) player.velX = -config.speed;
            else if (keys['ArrowRight']) player.velX = config.speed;
            else player.velX *= 0.8;

            if ((keys['ArrowUp'] || keys['Space'] || keys['ArrowUp']) && player.grounded) {
                player.velY = config.jumpStrength;
                player.grounded = false;
            }
            if (!(keys['ArrowUp'] || keys['Space']) && player.velY < -6) player.velY = -6;

            player.velY += config.gravity;
            player.x += player.velX;
            player.y += player.velY;

            // Collision with platforms
            player.grounded = false;
            platforms.forEach(p => {
                if (player.x + player.width > p.x && player.x < p.x + p.w) {
                    if (player.velY >= 0 && 
                        player.y + player.height <= p.y + player.velY + 12 && 
                        player.y + player.height >= p.y) {
                        player.y = p.y - player.height;
                        player.velY = 0;
                        player.grounded = true;
                    }
                }
            });

            // Bounds
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
            if (player.y > canvas.height + 50) {
                loseLife();
                player.y = canvas.height - config.groundHeight - player.height;
                player.x = canvas.width / 2;
                player.velY = 0;
            }

            // Picking up letters
            letters.forEach(l => {
                if (!l.collected) {
                    if (player.x < l.x + l.width && player.x + player.width > l.x &&
                        player.y < l.y + l.height && player.y + player.height > l.y) {
                        
                        const nextChar = targetWord[collectedLetters.length];
                        if (l.char === nextChar) {
                            l.collected = true;
                            collectedLetters += l.char;
                            document.getElementById('current-spelling').innerText = collectedLetters;
                            spawnParticles(l.x + 21, l.y + 21, '#4ade80');
                            
                            if (collectedLetters === targetWord) {
                                gameRunning = false;
                                setTimeout(() => {
                                    document.getElementById('win-message').innerText = `YOU SPELLED: ${targetWord}`;
                                    document.getElementById('win-modal').classList.remove('hidden');
                                }, 200);
                            }
                        } else {
                            loseLife();
                            // Push away from wrong letter
                            player.velY = -8;
                            player.velX = (player.x < l.x) ? -8 : 8;
                        }
                    }
                }
            });

            // Update particles
            for(let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.03;
                if(p.life <= 0) particles.splice(i, 1);
            }

            draw();
            requestAnimationFrame(gameLoop);
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Clouds
            ctx.fillStyle = "rgba(255,255,255,0.2)";
            clouds.forEach(c => {
                ctx.beginPath();
                ctx.arc(c.x, c.y, 40*c.s, 0, Math.PI*2);
                ctx.arc(c.x+30*c.s, c.y-15*c.s, 30*c.s, 0, Math.PI*2);
                ctx.arc(c.x-30*c.s, c.y-10*c.s, 25*c.s, 0, Math.PI*2);
                ctx.fill();
                c.x += c.v;
                if (c.x > canvas.width + 150) c.x = -150;
            });

            // Platforms
            platforms.forEach((p, i) => {
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.fillRect(p.x + 5, p.y + 5, p.w, p.h);

                ctx.fillStyle = i === 0 ? '#2e7d32' : '#5d4037';
                ctx.fillRect(p.x, p.y, p.w, p.h);
                
                ctx.fillStyle = i === 0 ? '#4caf50' : '#795548';
                ctx.fillRect(p.x, p.y, p.w, 6);
            });

            // Letters
            letters.forEach((l, idx) => {
                if (!l.collected) {
                    l.floating += 0.08;
                    const bounce = Math.sin(l.floating) * 10;
                    
                    // Highlight the next letter to find
                    const isNext = collectedLetters.length === idx;
                    if (isNext) {
                        ctx.shadowBlur = 20;
                        ctx.shadowColor = "white";
                    }

                    ctx.fillStyle = isNext ? '#ffee58' : '#fff59d';
                    ctx.beginPath();
                    ctx.arc(l.x + 21, l.y + 21 + bounce, 21, 0, Math.PI*2);
                    ctx.fill();
                    
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = '#000';
                    ctx.font = '16px "Press Start 2P"';
                    ctx.textAlign = 'center';
                    ctx.fillText(l.char, l.x + 21, l.y + 29 + bounce);
                }
            });

            // Player
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fillRect(player.x + 4, player.y + 4, player.width, player.height);
            ctx.fillStyle = player.color;
            ctx.fillRect(player.x, player.y, player.width, player.height);
            
            // Eyes
            ctx.fillStyle = '#fff';
            ctx.fillRect(player.x + 20, player.y + 10, 8, 8);
            ctx.fillStyle = '#000';
            ctx.fillRect(player.x + 24, player.y + 12, 4, 4);

            // Particles
            particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 4, 4);
            });
            ctx.globalAlpha = 1;
        }

        function spawnParticles(x, y, color) {
            for(let i=0; i<15; i++) {
                particles.push({
                    x, y, vx: (Math.random()-0.5)*12, vy: (Math.random()-0.5)*12,
                    life: 1.0, color
                });
            }
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if (gameRunning) setupLevel();
        }

        window.addEventListener('resize', resize);
        resize();
        initCategories();

    </script>
</body>
</html>
